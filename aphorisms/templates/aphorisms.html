{% extends "base.html" %}

{% block content %}

<script>
// Scripts for displaying aphorisms
// (Unfortunately Jinja won't read from an external js file)

	function display_article(contents_and_endnotes) {
		// Display contents on the page
		// Pass in an array [contents, endnotes]
		HTMLString = "<div class=article>" + contents_and_endnotes[0];
		if (contents_and_endnotes[1]) {
			HTMLString += "<div class=endnotes><p>NOTES</p>" + 
				contents_and_endnotes[1] + "</div>";
		}
		HTMLString += "</div>"
		displaybox.innerHTML = HTMLString;
	}

	function show_set_selections() {
		// Populate dropdown for set selection
		let HTMLString = "<select id='setselector'" +
			"value='' class='setselector'" +
			"onchange=show_selected_set()>" + 
			"<option selected disabled hidden>Select One Set</option>";
		let list_of_sets = get_list_of_sets();
		for (let i=0; i<list_of_sets.length; i++) {
			let setname = list_of_sets[i];
			HTMLString += "<option value= " + setname +
				">" + setname + "</option>";
		}
		HTMLString += "</select>";
		document.getElementById("select_set").innerHTML = HTMLString;
	}

	function show_selected_set() {
		let setname = document.getElementById("setselector").value;
		show_one_set(setname);
	}

	function show_view(viewname) {
		// Display aphorisms associated with view
		// Include suffixes
		let aphos_in_flow = "";
		let endnotes = "";
		// For each aphorism
		{% for a in aphos["aphorisms"] %}
			// Add to display if "view" matches requested
			if ("{{ a.view }}" == viewname) {
				aphos_in_flow += "<div class=apho>" + 
						"{{ a.contents|safe }}" + 
						"{{ a.suffix|safe }}" +
					"</div>";
				endnotes += "{{ a.endnote|safe }}";
			}
		{% endfor %}
		let contents_and_endnotes = [aphos_in_flow, endnotes];
		display_article(contents_and_endnotes);
	}

	function get_one_set(setname) {
		// Return aphos that have setname as their set
		// Include endnotes
		let aphos_in_set = "";
		let endnotes = "";
		{% for a in aphos["aphorisms"] %}
			if ("{{ a.set }}" == setname) {
				aphos_in_set += "<div class=apho>";
				aphos_in_set += "{{ a.contents|safe }}";
				aphos_in_set += "</div>";
				endnotes += "{{ a.endnote|safe }}";
			}
		{% endfor %}
		let contents_and_endnotes = [aphos_in_set, endnotes];
		return (contents_and_endnotes);
	}
		
	function show_one_set(setname) {
		let contents_and_endnotes = get_one_set(setname);
		contents_and_endnotes[0] = "<div class=set_header>" + 
			setname + "</div>" + contents_and_endnotes[0];
		display_article(contents_and_endnotes);
	}

	function show_one_set_random() {
		let list_of_sets = get_list_of_sets();
		let rndnum = Math.floor(Math.random() * list_of_sets.length);
		let setname = list_of_sets[rndnum];
		show_one_set(setname);
	}

	function get_list_of_sets() {
		// Return an array containing all the sets
		// Create a javascript set to remove duplicates
		let s = new(Set);
		{% for a in aphos["aphorisms"] %}
			s.add("{{ a.set }}");
		{% endfor %}
		// Convert to array in order to sort
		let list_of_sets = Array.from(s);
		list_of_sets.sort();
		return list_of_sets;
	}

	function show_all_by_set() {
		// Display the whole list of aphorisms
		let list_of_sets = get_list_of_sets();
		// Initialize arrays that will pass contents and endnotes
		//      as strings to be displayed
		let con_end_set = ["", ""];
		let con_end_all = ["", ""];
		for (let i=0; i<list_of_sets.length; i++) {
			let setname = list_of_sets[i];
			con_end_set = get_one_set(setname);
			con_end_set[0] = "<div class=set_header>" + 
				setname + "</div>" + con_end_set[0];
			// Append set contents to complete strings
			con_end_all[0] = con_end_all[0] + con_end_set[0];
			con_end_all[1] = con_end_all[1] + con_end_set[1];
		}
		display_article(con_end_all);
	}

	function show_random_one() {
		let numaphos = "{{ aphos.aphorisms|length }}";
		let rndnum = Math.floor(Math.random() * numaphos);
		let counter = 1;
		let aphofound = false;
		let apho_to_show = "";
		{% for a in aphos.aphorisms %}
			if (counter == rndnum) {
				if (aphofound == false) {
					apho_contents = "{{ a.contents|safe }}";
					apho_endnotes= "{{ a.endnote|safe }}"
					aphofound = true;
				}
				// Jinja does not seem to support
				//     breaking out of loops
				//     "|first" does not work
			} else {
				counter++;
			}
		{% endfor %}
		display_article([apho_contents, apho_endnotes]);
	}

</script>

<div class=bar_header>Aphorisms for the Neurodivergent</div>

<div class=article>
    <p><em>These are sayings I say to myself<br>
    in order to calm and center my consciousness<br>
    especially during episodes of anxiety or withdrawl</em></p>
    <p></p>
</div>

<div class=bar_action>
	<button onclick="show_view('flow')">The Basic Flow</button> 
	<button id=select_set>
		<script>show_set_selections()</script>
	</button>
	<button onclick="show_one_set_random()">One Random Set</button>
	<button onclick="show_all_by_set()">All by Set</button> 
	<button onclick="show_random_one()">Random One</button>
	<!-- TODO: <button onclick="show_random_all()">Random All</button> -->
</div>

<div id="displaybox">
	<script>show_view("flow");</script>
</div>

{% endblock %}
