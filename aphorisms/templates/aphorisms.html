{% extends "base.html" %}

{% block content %}

<script>
// Scripts for displaying aphorisms
// (Unfortunately Jinja won't read from an external js file)

	function display_article(contents, endnotes) {
		// Display contents on the page
		HTMLString = "<div class=article>" + contents;
		if (endnotes) {
			HTMLString += "<div class=endnotes><p>NOTES</p>" + 
				endnotes + "</div>";
		}
		HTMLString += "</div>"
		displaybox.innerHTML = HTMLString;
	}

	function show_set_selections() {
		// Populate dropdown for set selection
		let HTMLString = "<select id='setselector'" +
			"value='thedefault'" +
			"onchange=show_selected_set()>" + 
			"<option>Select One Set</option>";
		let list_of_sets = get_list_of_sets();
		for (let i=0; i<list_of_sets.length; i++) {
			let setname = list_of_sets[i];
			HTMLString += "<option value= " + setname +
				">" + setname + "</option>";
		}
		HTMLString += "</select>";
		document.getElementById("select_set").innerHTML = HTMLString;
	}

	function show_selected_set() {
		let setname = document.getElementById("setselector").value;
		show_one_set(setname);
	}

	function show_view(viewname) {
		console.log(viewname)
		// Display aphorisms associated with view
		// Include suffixes
		let aphos_in_flow = "";
		let endnotes = "";
		// For each aphorism
		{% for a in aphos["aphorisms"] %}
			// Add to display if "view" matches requested
			if ("{{ a.view }}" == viewname) {
				aphos_in_flow += "<div class=apho>" + 
						"{{ a.contents|safe }}" + 
						"{{ a.suffix|safe }}" +
					"</div>";
				endnotes += "{{ a.endnote|safe }}";
			}
		{% endfor %}
		display_article(aphos_in_flow, endnotes);
	}

	function get_one_set(setname) {
		// Return aphos that have setname as their set
		let aphos_in_set = "";
		{% for a in aphos["aphorisms"] %}
			if ("{{ a.set }}" == setname) {
				aphos_in_set += "<div class=apho>";
				aphos_in_set += "{{ a.contents|safe }}";
				aphos_in_set += "</div>";
			}
		{% endfor %}
		return aphos_in_set;
		}
		
	function show_one_set(setname) {
		set_to_show = "<div class=set_header>" + setname + "</div>";
		set_to_show += get_one_set(setname);
		display_article(set_to_show);
	}

	function show_one_set_random() {
		let list_of_sets = get_list_of_sets();
		let rndnum = Math.floor(Math.random() * list_of_sets.length);
		let setname = list_of_sets[rndnum];
		show_one_set(setname);
	}

	function get_list_of_sets() {
		// Return an array containing all the sets
		// Create a javascript set to remove duplicates
		let s = new(Set);
		{% for a in aphos["aphorisms"] %}
			s.add("{{ a.set }}");
		{% endfor %}
		// Convert to array in order to sort
		let list_of_sets = Array.from(s);
		list_of_sets.sort();
		return list_of_sets;
	}

	function show_all_by_set() {
		// Display the whole list of aphorisms
		let list_of_sets = get_list_of_sets();
		let aphos_all = "";
		for (let i=0; i<list_of_sets.length; i++) {
			let setname = list_of_sets[i];
			aphos_all += "<div class=set_header>" + setname + "</div>"
			aphos_all += get_one_set(setname);
		}
		display_article(aphos_all);
	}

	function show_random_one() {
		let numaphos = 0;
		{% for a in aphos["aphorisms"] %}
			numaphos++;
		{% endfor %}
		let rndnum = Math.floor(Math.random() * numaphos);
		let counter = 1;
		let aphofound = false;
		let apho_to_show = "";
		{% for a in aphos["aphorisms"] %}
			if (counter == rndnum) {
				if (aphofound == false) {
					apho_to_show = "{{ a.contents|safe }}";
					aphofound = true;
				}
				// TODO: Break out of loop in some way
				// Maybe use |first ?
			} else {
				counter++;
			}
		{% endfor %}
		display_article(apho_to_show);
		// TODO: This seems really hacky, to have to cycle
		// twice through the entire list of aphorisms.
		// Would be nice to put the javascript variable
		// into the Jinja:
		//     display_article(" aphos[ RNDNUM ].contents ")
		// although id is not necessary the same as ordinal
	}

</script>

<div class=bar_header>Aphorisms for the Neurodivergent</div>

<div class=article>
    <p><em>These are sayings I say to myself<br>
    in order to calm and center my consciousness<br>
    especially during episodes of withdrawl or anxiety.</em></p>
    <p></p>
</div>

<div class=bar_action>
	<button onclick="show_view('flow')">The Basic Flow</button> 
	<button id=select_set>
		<script>show_set_selections()</script>
	</button>
	<button onclick="show_one_set_random()">One Random Set</button>
	<button onclick="show_all_by_set()">All by Set</button> 
	<button onclick="show_random_one()">Random One</button>
	<!-- TODO: <button onclick="show_random_all()">Random All</button> -->
</div>

<div id="displaybox">
	<script>show_view("flow");</script>
</div>

{% endblock %}
